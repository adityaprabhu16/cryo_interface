<html>
    <head>
        <link rel="stylesheet" href="css/styling.css">
        <script src="plotly-2.19.1.min.js"></script>
        <script src="js/javascript.js"></script>
        <script>
            function start() {
                fetch('/api/start', {
                    method: 'POST'
                }).then(res=> res.json())
                .then(data => alert(data))
                .catch(err => {
                    console.log(err);
                });
            }

            function stop() {
                fetch('/api/stop', {
                    method: 'POST'
                }).then(res => res.json())
                .then(data => alert(data))
                .catch(err => {
                    console.log(err);
                });
            }

            function connect() {
                const port = document.getElementById("port").value;
                const json = JSON.stringify(port);
                fetch('/api/connect', {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        "length": json.length.toString()
                    },
                    method: "POST",
                    body: json
                })
                .then(res => {
                    if(res.status == 200){
                        alert("Successfully Connected!");
                    }
                    res.json()
                })
                .then(data =>{
                    alert(data);
                })
                .catch(err => { 
                    console.log("Failed to connect to USB device.");
                });
            }

            function connectVNA1() {
                const port = document.getElementById("vna1IP").value;
                const json = JSON.stringify(port);
                console.log(json)
                fetch('/api/connect_vna1', {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        "length": json.length.toString()
                    },
                    method: "POST",
                    body: json
                })
                .then(res => res.json())
                .then(data =>{
                    alert(data);
                })
                .catch(err => { 
                    console.log("Failed to connect to VNA.");
                });
            }

            function connectVNA2() {
                const port = document.getElementById("vna2IP").value;
                const json = JSON.stringify(port);
                console.log(json)
                fetch('/api/connect_vna2', {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        "length": json.length.toString()
                    },
                    method: "POST",
                    body: json
                })
                .then(res => res.json())
                .then(data =>{
                    alert(data);
                })
                .catch(err => { 
                    console.log("Failed to connect to VNA.");
                });
            }
        </script>
        <style>
            html {
                font-family: Arial;
            }
            .button {
                background-color: #008CBA; /* Blue */
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
            }

            input[type=text], select {
            width: 25%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            }

            input[type=submit] {
            width: 25%;
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            }

            input[type=submit]:hover {
            background-color: #45a049;
            }

            .tabcontent {
            display: none;
            }
            .fieldnotes {
                font-size: small;
                max-width: 50%;
            }
            /* li{
                font-size: small;
            } */
        </style>
    </head>
    <body>
        <div id="new_experiment" class="tabcontent">
            <form id="create_experiment">
                <p>
                    <label for="name">Name</label>
                    <input id="name" name="name" type="text" required>
                </p>
                <p>
                    <label for="cpa">CPA</label>
                    <input type="text" id="cpa" name="cpa" required>
                </p>
                <p>
                    <label for="date">Date</label>
                    <input type="date" id="date" name="date" required>
                </p>
                <p>
                    For the following Temperature sensor and VNA fields:
                    <ul>
                        <li>Check the box to use the corresponding device in your experiment</li>
                        <li>Put the title you wish to give the instrument you are using into the corresponding text box</li>
                    </ul>
                </p>
                <p>
                    <label for="temp1">Temp Sensor 1</label>
                    <input type="checkbox" id="temp1Checkbox" />
                    <input type="text" name="temp1" id="temp1" disabled />
                </p>
                <p>
                    <label for="temp2">Temp Sensor 2</label>
                    <input type="checkbox" id="temp2Checkbox" />
                    <input type="text" name="temp2" id="temp2" disabled />
                </p>
                <p class="fieldnotes">
                    Both temperature sensors are connected from the enclosure over USB. Sensors 1 and 2 correspond to the numbers on the sensor enclosure.
                </p>
                <p class="fieldnotes">
                    Compatible VNAs with this platform are:
                    <ul>
                        <li class="fieldnotes">N9914A (6.5GHz)</li>
                        <li class="fieldnotes">N9913A (4GHz)</li>
                    </ul>
                </p>
                <p>
                    <label for="vna1">VNA 1</label>
                    <input type="checkbox" id="vna1Checkbox" />
                    <input type="text" name="vna1" id="vna1" disabled />
                </p>
                <p>
                    <label for="vna2">VNA 2</label>
                    <input type="checkbox" id="vna2Checkbox" />
                    <input type="text" name="vna2" id="vna2" disabled />
                </p>
                
                <input type="submit" value="Create Experiment" class="button">
            </form>
            
            
        </div>
        <div id="dashboard" class="tabcontent">
            <div>
                <b>Metadata</b>
                <br><br>
                <b>Name: </b><span id="metadata-name"></span>
                <br>
                <b>CPA: </b><span id="metadata-cpa"></span>
                <br>
                <b>Date: </b><span id="metadata-date"></span>
                <br>
                <b>Temp1: </b><span id="metadata-temp1"></span>
                <br>
                <b>Temp2: </b><span id="metadata-temp2"></span>
                <br>
                <b>VNA 1: </b><span id="metadata-vna1"></span>
                <br>
                <b>VNA 2: </b><span id="metadata-vna2"></span>
            </div>
            <br><br>
            <div>
                <b>Temperature Sensor</b>
                <br><br>
                <select name="port" id="port">
                    <!-- <option value="COM3">COM3</option> -->
                </select>
                <button id="refresh" class="button">Refresh</button>
                <button id="connect" class="button">Connect</button>
            </div>
            <br><br>
            <div>
                <b>VNA</b>
                <br><br>
                <label>VNA 1 IP: </label>
                <input type="text" id="vna1IP" name="vna1IP">
                <button id="connectVNA1" class="button">Connect</button>
                <br><br>
                <label>VNA 2 IP: </label>
                <input type="text" id="vna2IP" name="vna2IP">
                <button id="connectVNA2" class="button">Connect</button>
            </div>
            <br><br>
            <div>
                <b>Select data sampling rate</b>
                <p class="fieldnotes">This will affect how often the frequency and temperature data will be collected and stored.
                    After the set period, the application will retreive a csv and S2P file from any connected VNAs.
                </p>
                <p class="fieldnotes"><strong>Warning: Setting a low period may result in unnecessarily large amounts of data.</strong></p>
                <br><br>
                <label for="datarate">Sampling Period: </label>
                <br>
                <input type="number" id="mins" name="mins"> mins
                <input type="number" id="datarate" name="datarate"> seconds
                <button id="cfgRate" class="button">Update Config</button>
            </div>
            <br><br>
            <div>
                <button id="startup" class="button">Start Logging</button>
                <button id="stop" class="button">Stop Logging</button>
            </div>
            <br>
            <div id="temp_plot"></div>
            <div id="vna1_plot"></div>
        </div>
        <script>
            document.getElementById('date').valueAsDate = new Date();

            // var experiment_selected = false;
            var formExp = document.getElementById("create_experiment");
            formExp.addEventListener("submit", ExpFrmHandler);

            document.getElementById("startup").addEventListener("click", start);
            document.getElementById("stop").addEventListener("click", stop);
            document.getElementById("connect").addEventListener("click", connect);
            document.getElementById("connectVNA1").addEventListener("click", connectVNA1);
            document.getElementById("connectVNA2").addEventListener("click", connectVNA2);
            document.getElementById("cfgRate").addEventListener("click", cfgRate);

            document.getElementById('temp1Checkbox').onchange = function() {
                document.getElementById('temp1').disabled = !this.checked;
            };

            document.getElementById('temp2Checkbox').onchange = function() {
                document.getElementById('temp2').disabled = !this.checked;
            };

            document.getElementById('vna1Checkbox').onchange = function() {
                document.getElementById('vna1').disabled = !this.checked;
            };

            document.getElementById('vna2Checkbox').onchange = function() {
                document.getElementById('vna2').disabled = !this.checked;
            };

            var tempPlot = Plotly.newPlot("temp_plot", {
                "data": [{
                    "x": [],
                    "y": [],
                    "name": "Temp 1",
                }, {
                    "x": [],
                    "y": [],
                    "name": "Temp 2",
                }],
                "layout": {
                    "width": 600,
                    "height": 400,
                    "title": "Temperature (Celsius)"},
                "type": "line"
            });

            function loadMetadata() {
                fetch('/api/metadata')
                .then(res => res.json())
                .then(data => {
                    document.getElementById("metadata-name").textContent = data.name;
                    document.getElementById("metadata-cpa").textContent = data.cpa;
                    document.getElementById("metadata-date").textContent = data.date;
                    
                    mdT1 = document.getElementById("metadata-temp1");
                    mdT1.textContent = data.temp1;
                    if(!document.getElementById("temp1").disabled && mdT1.textContent.length == 0){
                        mdT1.textContent = "x";
                    }
                    // document.getElementById("metadata-temp1").textContent = data.temp1;
                    mdT2 = document.getElementById("metadata-temp2");
                    mdT2.textContent = data.temp2;
                    if(!document.getElementById("temp2").disabled && mdT2.textContent.length == 0){
                        mdT2.textContent = "x";
                    }
                    // document.getElementById("metadata-temp2").textContent = data.temp2;
                    mdV1 = document.getElementById("metadata-vna1");
                    mdV1.textContent = data.vna1;
                    if(!document.getElementById("vna1").disabled && mdV1.textContent.length == 0){
                        mdV1.textContent = "x";
                    }
                    // document.getElementById("metadata-vna1").textContent = data.vna1;
                    mdV2 = document.getElementById("metadata-vna2");
                    mdV2.textContent = data.vna2;
                    if(!document.getElementById("vna2").disabled && mdV2.textContent.length == 0){
                        mdV2.textContent = "x";
                    }
                    // document.getElementById("metadata-vna2").textContent = data.vna2;


                })
                .catch(err => console.log(err));
            }

            function loadPorts() {
                fetch('/api/devices')
                .then(res => res.json())
                .then(data => {
                    const selector = document.querySelector("select");
                    const items = selector.length;
                    for (var i = items-1; i >= 0; i--) {
                        selector.remove(i);
                    }
                    for (const x of data) {
                        const op = new Option(x, x);
                        selector.add(op, undefined);
                    }
                })
                .catch(err => console.log(err));
            }

            function refresh() {
                loadPorts();
            }
            document.getElementById("refresh").addEventListener("click", refresh);

            function loadConfig() {
                fetch('/api/config')
                .then(res => res.json())
                .then(data => {
                    document.getElementById("datarate").value = data.period;
                })
                .catch(err => console.log(err));
            }

            loadMetadata();
            loadPorts();
            loadConfig();

            function selectScreen() {
                loadMetadata();

                fetch('/api/experiment_selected')
                .then(res => res.json())
                .then(selected => {
                    if (selected) {
                        var el = document.getElementById("new_experiment");
                        el.style.display = "none";
                        el = document.getElementById("dashboard");
                        el.style.display = "block";
                    } else {
                        var el = document.getElementById("new_experiment");
                        el.style.display = "block";
                        el = document.getElementById("dashboard");
                        el.style.display = "none";
                    }
                });
            }

            function ExpFrmHandler(event){
                event.preventDefault();
                // capture the form data
                const formData = new FormData(event.target);
                console.log(formData.entries());
                // convert the form data to JSON format
                const jsonObj = Object.fromEntries(formData.entries());
                console.log(jsonObj);
                const jsonData = JSON.stringify(jsonObj);

                fetch('/api/create_experiment', {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            "length": jsonData.length.toString()
                        },
                        method: "POST",
                        body: jsonData
                    })
                    .then(res => {
                        selectScreen();
                    })
                    .catch(err => { 
                        console.log("Failed to create experiment");
                    });
            }

            function vna1IPEventHandler(event){
                event.preventDefault();
                // capture the form data
                const formData = new FormData(event.target);
                console.log(formData.entries());
                // convert the form data to JSON format
                const jsonObj = Object.fromEntries(formData.entries());
                console.log(jsonObj);
                const jsonData = JSON.stringify(jsonObj);

                fetch('/api/connect_vna1', {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            "length": jsonData.length.toString()
                        },
                        method: "POST",
                        body: jsonData
                    })
                    .then(res => {
                        if (res.status == 200) {
                            alert("Connection successful.");
                        } else {
                            console.log("Failed to connect to VNA.");
                        }
                    })
                    .catch(err => { 
                        console.log("Failed to connect to VNA.");
                    });
            }

            
            
            function displayData(){
                var evtSource = new EventSource("api/stream_data");
                evtSource.addEventListener('temperature', (event) => {
                    const data = JSON.parse(event.data);
                    
                    // Create a Date object using the timestamp.
                    const t = new Date(data.time * 1000);

                    Plotly.extendTraces('temp_plot', {x: [[t]], y: [[data.temp1]]}, [0]);
                    Plotly.extendTraces('temp_plot', {x: [[t]], y: [[data.temp2]]}, [1]);
                });
            }

            function cfgRate(){
                var cfgJSON = {
                    "period": getPeriodSeconds()
                    // "period": document.getElementById("datarate").valueAsNumber,
                }   
                console.log(cfgJSON);
                fetch('/api/config', {
                    method:'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'length': JSON.stringify(cfgJSON).length.toString(),
                    },
                    body: JSON.stringify(cfgJSON),
                })
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    // TODO: use values we got back to update the UI
                })
                .catch(err =>{
                    alert("Failed to congifure data rate");
                });
            }

            function getPeriodSeconds(){
                var mins = document.getElementById("mins").valueAsNumber;
                var sec = document.getElementById("datarate").valueAsNumber;
                return (mins*60)+sec;
            }

            displayData();

            selectScreen();
            
        </script>
    </body>
</html>